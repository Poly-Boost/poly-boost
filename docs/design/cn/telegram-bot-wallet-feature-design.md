# Telegram Bot é’±åŒ…ç®¡ç†ä¸äº¤æ˜“åŠŸèƒ½è®¾è®¡æ–‡æ¡£

## 1. èƒŒæ™¯

### 1.1 åŠŸèƒ½ç®€ä»‹

ä¸º Polymarket Copy Trading Bot çš„ Telegram Bot è®¾è®¡å¹¶å®ç°å®Œæ•´çš„é’±åŒ…ç®¡ç†å’Œäº¤æ˜“åŠŸèƒ½ã€‚è¯¥åŠŸèƒ½å…è®¸ç”¨æˆ·é€šè¿‡ Telegram å¯¹è¯ç•Œé¢ç®¡ç†é’±åŒ…ã€æŸ¥çœ‹ä½™é¢ã€ç®¡ç†æŒä»“ã€è®¢å•å’Œæ´»åŠ¨å†å²ã€‚

### 1.2 éœ€æ±‚ä¸ç—›ç‚¹

**å½“å‰ç—›ç‚¹ï¼š**
- ç”¨æˆ·æ— æ³•é€šè¿‡ Telegram Bot ç®¡ç†è‡ªå·±çš„é’±åŒ…
- ç°æœ‰çš„ Bot å®ç°åªæœ‰åŸºç¡€çš„æŒä»“å’Œäº¤æ˜“åŠŸèƒ½ï¼Œç¼ºå°‘å®Œæ•´çš„ç”¨æˆ·ä½“éªŒ
- ç”¨æˆ·éœ€è¦æ‰‹åŠ¨è®°ä½é’±åŒ…åœ°å€ï¼Œæ²¡æœ‰æŒä¹…åŒ–å­˜å‚¨
- æ²¡æœ‰é’±åŒ…åˆå§‹åŒ–æµç¨‹å’Œç”¨æˆ·å¼•å¯¼

**ä¸šåŠ¡éœ€æ±‚ï¼š**
1. **é’±åŒ…ç®¡ç†**ï¼šç”¨æˆ·éœ€è¦èƒ½å¤Ÿåˆ›å»ºæ–°é’±åŒ…æˆ–å¯¼å…¥ç°æœ‰é’±åŒ…ï¼Œç³»ç»Ÿéœ€è¦å®‰å…¨å­˜å‚¨é’±åŒ…ä¿¡æ¯ï¼ˆåœ°å€å’Œç§é’¥ï¼‰
2. **ç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢**ï¼šç”¨æˆ·éœ€è¦å¿«é€ŸæŸ¥çœ‹é’±åŒ…åœ°å€ã€ä½™é¢å’Œæ”¶ç›Š
3. **æŒä»“ç®¡ç†**ï¼šç”¨æˆ·éœ€è¦æŸ¥çœ‹å’Œç®¡ç†å½“å‰çš„å¸‚åœºæŒä»“ï¼Œæ”¯æŒèµå›æˆ–å–å‡ºæ“ä½œ
4. **è®¢å•ç®¡ç†**ï¼šç”¨æˆ·éœ€è¦æŸ¥çœ‹æ´»è·ƒè®¢å•å¹¶æ”¯æŒå–æ¶ˆæ“ä½œ
5. **æ´»åŠ¨å†å²**ï¼šç”¨æˆ·éœ€è¦æŸ¥çœ‹äº¤æ˜“æ´»åŠ¨å†å²è®°å½•
6. **åˆ†é¡µæ”¯æŒ**ï¼šåˆ—è¡¨æ•°æ®éœ€è¦æ”¯æŒç¿»é¡µï¼Œé¿å…æ¶ˆæ¯è¿‡é•¿

### 1.3 ä½¿ç”¨åœºæ™¯

**åœºæ™¯ 1ï¼šæ–°ç”¨æˆ·åˆæ¬¡ä½¿ç”¨**
1. ç”¨æˆ·å‘é€ `/start` å‘½ä»¤
2. Bot è¯¢é—®ç”¨æˆ·æ˜¯å¦è¦ç”Ÿæˆæ–°é’±åŒ…æˆ–ä½¿ç”¨ç°æœ‰é’±åŒ…
3. ç”¨æˆ·é€‰æ‹©ç”Ÿæˆæ–°é’±åŒ…ï¼ŒBot ç”Ÿæˆå¹¶è¿”å›é’±åŒ…åœ°å€
4. Bot æ˜¾ç¤ºç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯ï¼ˆåœ°å€ã€ä½™é¢ï¼‰

**åœºæ™¯ 2ï¼šæŸ¥çœ‹å’Œç®¡ç†æŒä»“**
1. ç”¨æˆ·å‘é€ `/positions` å‘½ä»¤
2. Bot æ˜¾ç¤ºå‰10ä¸ªæŒä»“ï¼Œå¹¶æä¾›ç¿»é¡µæŒ‰é’®
3. ç”¨æˆ·é€‰æ‹©æŸä¸ªæŒä»“ï¼ˆé€šè¿‡ç´¢å¼•ï¼‰
4. Bot æ£€æŸ¥æ˜¯å¦å¯èµå›ï¼Œæ˜¾ç¤ºç›¸åº”çš„æ“ä½œæŒ‰é’®ï¼ˆèµå›/å¸‚ä»·å–å‡º/é™ä»·å–å‡ºï¼‰

**åœºæ™¯ 3ï¼šæŸ¥çœ‹å’Œå–æ¶ˆè®¢å•**
1. ç”¨æˆ·å‘é€ `/orders` å‘½ä»¤
2. Bot æ˜¾ç¤ºæ´»è·ƒè®¢å•åˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰
3. ç”¨æˆ·é€‰æ‹©æŸä¸ªè®¢å•
4. Bot æ˜¾ç¤ºè®¢å•è¯¦æƒ…å’Œå–æ¶ˆæŒ‰é’®

**åœºæ™¯ 4ï¼šå……å€¼é’±åŒ…**
1. ç”¨æˆ·å‘é€ `/fund` å‘½ä»¤
2. Bot æ˜¾ç¤ºé’±åŒ…åœ°å€ï¼ˆå¸¦äºŒç»´ç ï¼‰å’Œå……å€¼æç¤º
3. æç¤ºç”¨æˆ·ä½¿ç”¨ Polygon é“¾çš„ USDC

## 2. æ¦‚è¦è®¾è®¡

æ•´ä½“å®ç°æ€è·¯ï¼š
1. ä½¿ç”¨æ•°æ®åº“ï¼ˆSQLiteï¼‰æŒä¹…åŒ–å­˜å‚¨ç”¨æˆ·çš„é’±åŒ…ä¿¡æ¯ï¼ˆtelegram_user_id -> walletï¼‰
2. åˆ›å»º [`UserWalletService`](poly_boost/services/user_wallet_service.py:1) ç®¡ç†ç”¨æˆ·é’±åŒ…çš„ CRUD æ“ä½œ
3. æ‰©å±•ç°æœ‰çš„ bot handlersï¼Œå®ç°å„ä¸ªå‘½ä»¤çš„äº¤äº’é€»è¾‘
4. ä½¿ç”¨ ConversationHandler ç®¡ç†å¤šæ­¥éª¤äº¤äº’æµç¨‹ï¼ˆå¦‚é’±åŒ…åˆå§‹åŒ–ï¼‰
5. å®ç°åˆ†é¡µç»„ä»¶ [`PaginationHelper`](poly_boost/bot/utils/pagination.py:1) å¤„ç†åˆ—è¡¨ç¿»é¡µ

```mermaid
flowchart TD
    A[ç”¨æˆ·å‘é€å‘½ä»¤] --> B{é’±åŒ…å·²åˆå§‹åŒ–?}
    B -->|å¦| C[å¼•å¯¼é’±åŒ…åˆå§‹åŒ–æµç¨‹]
    B -->|æ˜¯| D[åŠ è½½ç”¨æˆ·é’±åŒ…]
    C --> E[ç”Ÿæˆæ–°é’±åŒ… OR å¯¼å…¥ç§é’¥]
    E --> F[ä¿å­˜åˆ°æ•°æ®åº“]
    F --> D
    D --> G{å‘½ä»¤ç±»å‹}
    G -->|/start| H[æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯]
    G -->|/profile| I[è¿”å›Profileé“¾æ¥]
    G -->|/fund| J[æ˜¾ç¤ºå……å€¼ä¿¡æ¯]
    G -->|/wallet| K[æ˜¾ç¤ºé’±åŒ…è¯¦æƒ…]
    G -->|/positions| L[æŸ¥è¯¢å¹¶å±•ç¤ºæŒä»“åˆ—è¡¨]
    G -->|/orders| M[æŸ¥è¯¢å¹¶å±•ç¤ºè®¢å•åˆ—è¡¨]
    G -->|/activities| N[æŸ¥è¯¢å¹¶å±•ç¤ºæ´»åŠ¨å†å²]
    L --> O[ç”¨æˆ·é€‰æ‹©æŒä»“]
    O --> P[æ˜¾ç¤ºæ“ä½œæŒ‰é’®]
    M --> Q[ç”¨æˆ·é€‰æ‹©è®¢å•]
    Q --> R[æ˜¾ç¤ºå–æ¶ˆæŒ‰é’®]
```

### 2.1 æ¨¡å—åˆ’åˆ†

*   **[`UserWalletService`](poly_boost/services/user_wallet_service.py:1)**ï¼šè´Ÿè´£ç”¨æˆ·é’±åŒ…çš„æ•°æ®åº“ CRUD æ“ä½œï¼Œå…³è” Telegram User ID å’Œ Wallet
*   **[`WalletHandler`](poly_boost/bot/handlers/wallet_handler.py:1)**ï¼šå¤„ç† `/start`ã€`/wallet`ã€`/fund`ã€`/profile` ç­‰é’±åŒ…ç›¸å…³å‘½ä»¤
*   **[`PositionHandler`](poly_boost/bot/handlers/position_handler.py:1)** (æ‰©å±•)ï¼šå¤„ç† `/positions` å‘½ä»¤ï¼Œæ”¯æŒåˆ†é¡µå’ŒæŒä»“æ“ä½œ
*   **[`OrderHandler`](poly_boost/bot/handlers/order_handler.py:1)**ï¼šå¤„ç† `/orders` å‘½ä»¤ï¼Œæ”¯æŒåˆ†é¡µå’Œè®¢å•å–æ¶ˆ
*   **[`ActivityHandler`](poly_boost/bot/handlers/activity_handler.py:1)**ï¼šå¤„ç† `/activities` å‘½ä»¤ï¼Œæ”¯æŒåˆ†é¡µ
*   **[`PaginationHelper`](poly_boost/bot/utils/pagination.py:1)**ï¼šé€šç”¨åˆ†é¡µç»„ä»¶ï¼Œç®¡ç†åˆ—è¡¨æ•°æ®çš„åˆ†é¡µæ˜¾ç¤º
*   **[`WalletInitConversation`](poly_boost/bot/conversations/wallet_init.py:1)**ï¼šé’±åŒ…åˆå§‹åŒ–å¯¹è¯æµç¨‹ï¼Œä½¿ç”¨ ConversationHandler

### 2.2 æ ¸å¿ƒæµç¨‹

1.  **é’±åŒ…åˆå§‹åŒ–æµç¨‹**ï¼š
    - ç”¨æˆ·é¦–æ¬¡ä½¿ç”¨ `/start` æ—¶ï¼Œæ£€æŸ¥æ•°æ®åº“ä¸­æ˜¯å¦å­˜åœ¨è¯¥ç”¨æˆ·çš„é’±åŒ…
    - å¦‚æœä¸å­˜åœ¨ï¼Œå¯åŠ¨ ConversationHandlerï¼Œè¯¢é—®ç”¨æˆ·é€‰æ‹©ï¼ˆç”Ÿæˆ/å¯¼å…¥ï¼‰
    - æ ¹æ®ç”¨æˆ·é€‰æ‹©ï¼Œç”Ÿæˆæ–°é’±åŒ…æˆ–è¯·æ±‚ç§é’¥
    - å°†é’±åŒ…ä¿¡æ¯ä¿å­˜åˆ°æ•°æ®åº“ï¼Œå…³è” telegram_user_id

2.  **åˆ†é¡µæŸ¥è¯¢æµç¨‹**ï¼š
    - ç”¨æˆ·å‘é€å‘½ä»¤ï¼ˆå¦‚ `/positions`ï¼‰
    - Handler ä»æœåŠ¡å±‚è·å–æ•°æ®ï¼Œä½¿ç”¨ PaginationHelper åˆ†é¡µ
    - æ¸²æŸ“å½“å‰é¡µæ•°æ®å’Œç¿»é¡µæŒ‰é’®ï¼ˆä¸Šä¸€é¡µ/ä¸‹ä¸€é¡µï¼‰
    - ç”¨æˆ·ç‚¹å‡»ç¿»é¡µæŒ‰é’®ï¼Œæ›´æ–° callback_queryï¼Œé‡æ–°æ¸²æŸ“

3.  **æŒä»“æ“ä½œæµç¨‹**ï¼š
    - ç”¨æˆ·åœ¨æŒä»“åˆ—è¡¨ä¸­é€‰æ‹©æŸä¸ªæŒä»“ï¼ˆé€šè¿‡ indexï¼‰
    - Handler è·å–è¯¥æŒä»“çš„è¯¦ç»†ä¿¡æ¯
    - æ£€æŸ¥æ˜¯å¦å¯èµå›ï¼ˆå¸‚åœºå·²ç»“æŸä¸”æŒæœ‰æ­£ç¡®ç»“æœï¼‰
    - æ˜¾ç¤ºç›¸åº”çš„æ“ä½œæŒ‰é’®ï¼ˆèµå›/å¸‚ä»·å–å‡º/é™ä»·å–å‡ºï¼‰
    - ç”¨æˆ·ç‚¹å‡»æŒ‰é’®ï¼Œè°ƒç”¨ [`OrderService`](poly_boost/services/order_service.py:1) æ‰§è¡Œæ“ä½œ

## 3. æ•°æ®æ¨¡å‹/ç±»å›¾/APIè®¾è®¡

### 3.1 æ•°æ®ç»“æ„

**æ•°æ®åº“è¡¨ï¼š`user_wallets`**

```sql
CREATE TABLE user_wallets (
    telegram_user_id INTEGER PRIMARY KEY,
    wallet_address TEXT NOT NULL,
    private_key_encrypted TEXT NOT NULL,
    wallet_name TEXT,
    signature_type INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**ç”¨æˆ·é’±åŒ…æ•°æ®æ¨¡å‹**

```mermaid
classDiagram
    class UserWallet {
        +int telegram_user_id
        +str wallet_address
        +str private_key_encrypted
        +str wallet_name
        +int signature_type
        +datetime created_at
        +datetime updated_at
        +to_wallet() Wallet
    }
    
    class PaginatedData {
        +List~T~ items
        +int page
        +int page_size
        +int total_items
        +int total_pages
        +bool has_next
        +bool has_prev
    }
    
    UserWallet --> Wallet: converts to
```

### 3.2 API è®¾è®¡

**UserWalletService æ¥å£**

```python
class UserWalletService:
    def create_user_wallet(
        self,
        telegram_user_id: int,
        wallet_address: str,
        private_key: str,
        wallet_name: Optional[str] = None,
        signature_type: int = 0
    ) -> UserWallet:
        """åˆ›å»ºç”¨æˆ·é’±åŒ…è®°å½•"""
        
    def get_user_wallet(self, telegram_user_id: int) -> Optional[UserWallet]:
        """è·å–ç”¨æˆ·é’±åŒ…"""
        
    def update_user_wallet(self, telegram_user_id: int, **kwargs) -> UserWallet:
        """æ›´æ–°ç”¨æˆ·é’±åŒ…ä¿¡æ¯"""
        
    def delete_user_wallet(self, telegram_user_id: int) -> bool:
        """åˆ é™¤ç”¨æˆ·é’±åŒ…"""
        
    def wallet_exists(self, telegram_user_id: int) -> bool:
        """æ£€æŸ¥ç”¨æˆ·é’±åŒ…æ˜¯å¦å­˜åœ¨"""
```

**PaginationHelper æ¥å£**

```python
class PaginationHelper:
    @staticmethod
    def paginate(
        items: List[T],
        page: int = 1,
        page_size: int = 10
    ) -> PaginatedData[T]:
        """åˆ†é¡µæ•°æ®"""
        
    @staticmethod
    def create_pagination_keyboard(
        paginated_data: PaginatedData,
        callback_prefix: str,
        additional_buttons: Optional[List[InlineKeyboardButton]] = None
    ) -> InlineKeyboardMarkup:
        """åˆ›å»ºåˆ†é¡µé”®ç›˜"""
```

## 4. è¯¦ç»†è®¾è®¡

### 4.1 æµç¨‹ä¸€ï¼šé’±åŒ…åˆå§‹åŒ–æµç¨‹

```mermaid
sequenceDiagram
    participant User
    participant Bot
    participant WalletInitConversation
    participant UserWalletService
    participant Database
    
    User->>Bot: /start
    Bot->>UserWalletService: wallet_exists(telegram_user_id)
    UserWalletService->>Database: SELECT * FROM user_wallets
    Database-->>UserWalletService: None
    UserWalletService-->>Bot: False
    
    Bot->>WalletInitConversation: å¯åŠ¨å¯¹è¯æµç¨‹
    WalletInitConversation->>User: è¯¢é—®ç”Ÿæˆæ–°é’±åŒ…è¿˜æ˜¯ä½¿ç”¨ç°æœ‰é’±åŒ…
    User->>WalletInitConversation: é€‰æ‹©"ç”Ÿæˆæ–°é’±åŒ…"
    
    WalletInitConversation->>WalletInitConversation: ç”Ÿæˆæ–°çš„EOAé’±åŒ…
    WalletInitConversation->>UserWalletService: create_user_wallet()
    UserWalletService->>Database: INSERT INTO user_wallets
    Database-->>UserWalletService: Success
    UserWalletService-->>WalletInitConversation: UserWallet
    
    WalletInitConversation->>Bot: å®Œæˆåˆå§‹åŒ–
    Bot->>User: æ˜¾ç¤ºé’±åŒ…åœ°å€å’Œä½™é¢
```

**æµç¨‹è¯´æ˜ï¼š**

1. ç”¨æˆ·å‘é€ `/start` å‘½ä»¤
2. Bot æ£€æŸ¥æ•°æ®åº“ä¸­æ˜¯å¦å­˜åœ¨è¯¥ç”¨æˆ·çš„é’±åŒ…è®°å½•
3. å¦‚æœä¸å­˜åœ¨ï¼Œå¯åŠ¨ ConversationHandler
4. æ˜¾ç¤ºé€‰æ‹©æŒ‰é’®ï¼šã€Œç”Ÿæˆæ–°é’±åŒ…ã€ã€Œä½¿ç”¨ç°æœ‰é’±åŒ…ã€
5. ç”¨æˆ·é€‰æ‹©ã€Œç”Ÿæˆæ–°é’±åŒ…ã€ï¼š
   - ä½¿ç”¨ [`Account.create()`](poly_boost/bot/conversations/wallet_init.py:45) ç”Ÿæˆæ–°çš„ EOA é’±åŒ…
   - å°†åœ°å€å’ŒåŠ å¯†åçš„ç§é’¥ä¿å­˜åˆ°æ•°æ®åº“
   - è¿”å›é’±åŒ…åœ°å€ç»™ç”¨æˆ·
6. ç”¨æˆ·é€‰æ‹©ã€Œä½¿ç”¨ç°æœ‰é’±åŒ…ã€ï¼š
   - æç¤ºç”¨æˆ·è¾“å…¥ç§é’¥
   - éªŒè¯ç§é’¥æ ¼å¼
   - ä»ç§é’¥æ¢å¤åœ°å€
   - ä¿å­˜åˆ°æ•°æ®åº“

#### 4.1.1 ç”Ÿæˆæ–°é’±åŒ…æ­¥éª¤

```python
from eth_account import Account

# 1. ç”Ÿæˆæ–°è´¦æˆ·
account = Account.create()
wallet_address = account.address
private_key = account.key.hex()

# 2. åŠ å¯†ç§é’¥ï¼ˆä½¿ç”¨ç®€å•çš„ç¯å¢ƒå˜é‡å¯†é’¥ï¼‰
encrypted_key = encrypt_private_key(private_key, encryption_key)

# 3. ä¿å­˜åˆ°æ•°æ®åº“
user_wallet_service.create_user_wallet(
    telegram_user_id=user.id,
    wallet_address=wallet_address,
    private_key_encrypted=encrypted_key,
    wallet_name=f"Wallet_{user.id}"
)
```

#### 4.1.2 å¯¼å…¥ç°æœ‰é’±åŒ…æ­¥éª¤

```python
# 1. ç”¨æˆ·è¾“å…¥ç§é’¥
private_key = update.message.text.strip()

# 2. éªŒè¯ç§é’¥å¹¶æ¢å¤åœ°å€
try:
    account = Account.from_key(private_key)
    wallet_address = account.address
except Exception as e:
    # æç¤ºç”¨æˆ·ç§é’¥æ ¼å¼é”™è¯¯
    return RETRY_INPUT

# 3. åŠ å¯†å¹¶ä¿å­˜
encrypted_key = encrypt_private_key(private_key, encryption_key)
user_wallet_service.create_user_wallet(...)
```

### 4.2 æµç¨‹äºŒï¼šæŒä»“åˆ—è¡¨æŸ¥è¯¢ä¸æ“ä½œ

```mermaid
sequenceDiagram
    participant User
    participant Bot
    participant PositionHandler
    participant UserWalletService
    participant PositionService
    participant PaginationHelper
    
    User->>Bot: /positions
    Bot->>UserWalletService: get_user_wallet(telegram_user_id)
    UserWalletService-->>Bot: UserWallet
    
    Bot->>PositionHandler: handle_positions_command()
    PositionHandler->>PositionService: get_positions(wallet)
    PositionService-->>PositionHandler: List[Position]
    
    PositionHandler->>PaginationHelper: paginate(positions, page=1, page_size=10)
    PaginationHelper-->>PositionHandler: PaginatedData
    
    PositionHandler->>PositionHandler: æ ¼å¼åŒ–æŒä»“åˆ—è¡¨
    PositionHandler->>User: æ˜¾ç¤ºå‰10ä¸ªæŒä»“ + ç¿»é¡µæŒ‰é’® + é€‰æ‹©æŒ‰é’®
    
    User->>Bot: ç‚¹å‡»"é€‰æ‹©æŒä»“ #3"
    Bot->>PositionHandler: handle_position_select(index=3)
    PositionHandler->>PositionHandler: æ£€æŸ¥æ˜¯å¦å¯èµå›
    
    alt å¸‚åœºå·²ç»“æŸä¸”å¯èµå›
        PositionHandler->>User: æ˜¾ç¤ºã€Œèµå›ã€æŒ‰é’®
    else å¸‚åœºæœªç»“æŸ
        PositionHandler->>User: æ˜¾ç¤ºã€Œå¸‚ä»·å–å‡ºã€ã€Œé™ä»·å–å‡ºã€æŒ‰é’®
    end
    
    User->>Bot: ç‚¹å‡»ã€Œèµå›ã€
    Bot->>PositionHandler: handle_redeem(position)
    PositionHandler->>PositionService: claim_rewards(...)
    PositionService-->>PositionHandler: Success
    PositionHandler->>User: âœ… èµå›æˆåŠŸ
```

**æµç¨‹è¯´æ˜ï¼š**

1. ç”¨æˆ·å‘é€ `/positions` å‘½ä»¤
2. Handler ä»æ•°æ®åº“åŠ è½½ç”¨æˆ·é’±åŒ…ï¼Œè½¬æ¢ä¸º [`Wallet`](poly_boost/core/wallet.py:17) å¯¹è±¡
3. è°ƒç”¨ [`PositionService.get_positions()`](poly_boost/services/position_service.py:74) è·å–æ‰€æœ‰æŒä»“
4. ä½¿ç”¨ [`PaginationHelper.paginate()`](poly_boost/bot/utils/pagination.py:15) å¯¹æ•°æ®åˆ†é¡µ
5. æ¸²æŸ“å½“å‰é¡µçš„æŒä»“åˆ—è¡¨ï¼ˆæ¯è¡Œæ˜¾ç¤ºï¼šç´¢å¼•ã€å¸‚åœºåç§°ã€outcomeã€æ•°é‡ã€ä»·å€¼ï¼‰
6. æ·»åŠ ç¿»é¡µæŒ‰é’®å’Œé€‰æ‹©æŒ‰é’®
7. ç”¨æˆ·ç‚¹å‡»é€‰æ‹©æŸä¸ªæŒä»“ï¼Œæ˜¾ç¤ºè¯¦æƒ…å’Œæ“ä½œæŒ‰é’®
8. ç”¨æˆ·æ‰§è¡Œæ“ä½œï¼ˆèµå›/å–å‡ºï¼‰ï¼Œè°ƒç”¨å¯¹åº”çš„æœåŠ¡æ–¹æ³•

#### 4.2.1 æŒä»“åˆ—è¡¨æ ¼å¼åŒ–

```python
def format_positions_message(paginated_data: PaginatedData[Position]) -> str:
    message = f"ğŸ“Š æŒä»“åˆ—è¡¨ (ç¬¬ {paginated_data.page}/{paginated_data.total_pages} é¡µ)\n\n"
    
    for i, position in enumerate(paginated_data.items, start=(paginated_data.page-1)*paginated_data.page_size):
        market_name = position.market_question[:30] + "..."
        outcome = "âœ…" if position.outcome == "Yes" else "âŒ"
        size = position.size
        value = position.value
        
        message += f"{i+1}. {market_name}\n"
        message += f"   {outcome} {size:.2f} shares (${value:.2f})\n\n"
    
    return message
```

#### 4.2.2 æŒä»“æ“ä½œæŒ‰é’®ç”Ÿæˆ

```python
def create_position_action_buttons(position: Position) -> InlineKeyboardMarkup:
    buttons = []
    
    # æ£€æŸ¥æ˜¯å¦å¯èµå›
    if position.is_redeemable:
        buttons.append([
            InlineKeyboardButton("ğŸ èµå›", callback_data=f"pos_redeem_{position.token_id}")
        ])
    else:
        buttons.append([
            InlineKeyboardButton("ğŸ’° å¸‚ä»·å–å‡º", callback_data=f"pos_sell_market_{position.token_id}"),
            InlineKeyboardButton("ğŸ“ˆ é™ä»·å–å‡º", callback_data=f"pos_sell_limit_{position.token_id}")
        ])
    
    buttons.append([InlineKeyboardButton("ğŸ”™ è¿”å›", callback_data="pos_list")])
    return InlineKeyboardMarkup(buttons)
```

### 4.3 æµç¨‹ä¸‰ï¼šè®¢å•åˆ—è¡¨ä¸å–æ¶ˆ

```mermaid
sequenceDiagram
    participant User
    participant Bot
    participant OrderHandler
    participant OrderService
    
    User->>Bot: /orders
    Bot->>OrderHandler: handle_orders_command()
    OrderHandler->>OrderService: get_orders()
    OrderService-->>OrderHandler: List[Order]
    
    OrderHandler->>OrderHandler: paginate(orders)
    OrderHandler->>User: æ˜¾ç¤ºè®¢å•åˆ—è¡¨ + é€‰æ‹©æŒ‰é’®
    
    User->>Bot: ç‚¹å‡»"é€‰æ‹©è®¢å• #2"
    Bot->>OrderHandler: handle_order_select(index=2)
    OrderHandler->>User: æ˜¾ç¤ºè®¢å•è¯¦æƒ… + å–æ¶ˆæŒ‰é’®
    
    User->>Bot: ç‚¹å‡»ã€Œå–æ¶ˆè®¢å•ã€
    Bot->>OrderHandler: handle_order_cancel(order_id)
    OrderHandler->>OrderService: cancel_order(order_id)
    OrderService-->>OrderHandler: Success
    OrderHandler->>User: âœ… è®¢å•å·²å–æ¶ˆ
```

**æµç¨‹è¯´æ˜ï¼š**

1. ç”¨æˆ·å‘é€ `/orders` å‘½ä»¤
2. Handler è°ƒç”¨ [`OrderService.get_orders()`](poly_boost/services/order_service.py:526) è·å–æ´»è·ƒè®¢å•
3. åˆ†é¡µå¹¶æ˜¾ç¤ºè®¢å•åˆ—è¡¨ï¼ˆåŒ…å«ï¼šè®¢å•IDã€å¸‚åœºåç§°ã€æ–¹å‘ã€ä»·æ ¼ã€æ•°é‡ã€çŠ¶æ€ï¼‰
4. ç”¨æˆ·é€‰æ‹©æŸä¸ªè®¢å•ï¼Œæ˜¾ç¤ºè¯¦æƒ…å’Œå–æ¶ˆæŒ‰é’®
5. ç”¨æˆ·ç‚¹å‡»å–æ¶ˆï¼Œè°ƒç”¨ [`OrderService.cancel_order()`](poly_boost/services/order_service.py:590)

### 4.4 æµç¨‹å››ï¼šæ´»åŠ¨å†å²æŸ¥è¯¢

```mermaid
sequenceDiagram
    participant User
    participant Bot
    participant ActivityHandler
    participant ActivityService
    
    User->>Bot: /activities
    Bot->>ActivityHandler: handle_activities_command()
    ActivityHandler->>ActivityService: get_activity(wallet, limit=100)
    ActivityService-->>ActivityHandler: List[Activity]
    
    ActivityHandler->>ActivityHandler: paginate(activities, page_size=10)
    ActivityHandler->>User: æ˜¾ç¤ºæ´»åŠ¨åˆ—è¡¨ + ç¿»é¡µæŒ‰é’®
    
    User->>Bot: ç‚¹å‡»ã€Œä¸‹ä¸€é¡µã€
    Bot->>ActivityHandler: handle_page_change(page=2)
    ActivityHandler->>User: æ˜¾ç¤ºç¬¬2é¡µæ´»åŠ¨
```

**æµç¨‹è¯´æ˜ï¼š**

1. ç”¨æˆ·å‘é€ `/activities` å‘½ä»¤
2. Handler è°ƒç”¨ [`ActivityService.get_activity()`](poly_boost/services/activity_service.py:70) è·å–æ´»åŠ¨å†å²
3. åˆ†é¡µæ˜¾ç¤ºï¼ˆæ¯é¡µ10æ¡ï¼‰
4. æ¯æ¡æ´»åŠ¨æ˜¾ç¤ºï¼šæ—¶é—´ã€ç±»å‹ã€å¸‚åœºåç§°ã€æ–¹å‘ã€æ•°é‡ã€ä»·æ ¼

## 5. ä¼ªä»£ç å®ç°

### 5.1 é’±åŒ…åˆå§‹åŒ–å¯¹è¯æµç¨‹ä¼ªä»£ç 

```python
from telegram.ext import ConversationHandler, CommandHandler, MessageHandler, CallbackQueryHandler

# çŠ¶æ€å¸¸é‡
WALLET_CHOICE, INPUT_PRIVATE_KEY = range(2)

async def start_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    
    # æ£€æŸ¥æ˜¯å¦å·²æœ‰é’±åŒ…
    if user_wallet_service.wallet_exists(user_id):
        wallet = user_wallet_service.get_user_wallet(user_id)
        balance = wallet_service.get_balance(wallet.to_wallet())
        
        await update.message.reply_text(
            f"ğŸ‘› æ‚¨çš„é’±åŒ…ä¿¡æ¯:\n"
            f"åœ°å€: `{wallet.wallet_address}`\n"
            f"ä½™é¢: ${balance:.2f} USDC",
            parse_mode="Markdown"
        )
        return ConversationHandler.END
    
    # å¯åŠ¨é’±åŒ…åˆå§‹åŒ–æµç¨‹
    keyboard = [
        [InlineKeyboardButton("ğŸ†• ç”Ÿæˆæ–°é’±åŒ…", callback_data="wallet_generate")],
        [InlineKeyboardButton("ğŸ“¥ ä½¿ç”¨ç°æœ‰é’±åŒ…", callback_data="wallet_import")]
    ]
    
    await update.message.reply_text(
        "æ¬¢è¿ä½¿ç”¨ Polymarket Bot!\n\n"
        "è¯·é€‰æ‹©é’±åŒ…è®¾ç½®æ–¹å¼:",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )
    
    return WALLET_CHOICE

async def wallet_choice_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    
    if query.data == "wallet_generate":
        # ç”Ÿæˆæ–°é’±åŒ…
        account = Account.create()
        wallet_address = account.address
        private_key = account.key.hex()
        
        # åŠ å¯†å¹¶ä¿å­˜
        encrypted_key = encrypt_private_key(private_key, ENCRYPTION_KEY)
        user_wallet_service.create_user_wallet(
            telegram_user_id=query.from_user.id,
            wallet_address=wallet_address,
            private_key_encrypted=encrypted_key
        )
        
        await query.edit_message_text(
            f"âœ… é’±åŒ…åˆ›å»ºæˆåŠŸ!\n\n"
            f"åœ°å€: `{wallet_address}`\n\n"
            f"âš ï¸ è¯·åŠ¡å¿…ä¿å­˜ä»¥ä¸‹ç§é’¥:\n"
            f"`{private_key}`\n\n"
            f"ç§é’¥ä¸¢å¤±å°†æ— æ³•æ‰¾å›!",
            parse_mode="Markdown"
        )
        
        return ConversationHandler.END
    
    elif query.data == "wallet_import":
        await query.edit_message_text(
            "è¯·å‘é€æ‚¨çš„é’±åŒ…ç§é’¥:\n"
            "(æ ¼å¼: 0x...)"
        )
        return INPUT_PRIVATE_KEY

async def receive_private_key(update: Update, context: ContextTypes.DEFAULT_TYPE):
    private_key = update.message.text.strip()
    
    try:
        # éªŒè¯ç§é’¥
        account = Account.from_key(private_key)
        wallet_address = account.address
        
        # åŠ å¯†å¹¶ä¿å­˜
        encrypted_key = encrypt_private_key(private_key, ENCRYPTION_KEY)
        user_wallet_service.create_user_wallet(
            telegram_user_id=update.effective_user.id,
            wallet_address=wallet_address,
            private_key_encrypted=encrypted_key
        )
        
        # åˆ é™¤åŒ…å«ç§é’¥çš„æ¶ˆæ¯
        await update.message.delete()
        
        await update.message.reply_text(
            f"âœ… é’±åŒ…å¯¼å…¥æˆåŠŸ!\n"
            f"åœ°å€: `{wallet_address}`",
            parse_mode="Markdown"
        )
        
        return ConversationHandler.END
        
    except Exception as e:
        await update.message.reply_text(
            "âŒ ç§é’¥æ ¼å¼é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥:"
        )
        return INPUT_PRIVATE_KEY

# ConversationHandler é…ç½®
wallet_init_handler = ConversationHandler(
    entry_points=[CommandHandler("start", start_command)],
    states={
        WALLET_CHOICE: [CallbackQueryHandler(wallet_choice_callback)],
        INPUT_PRIVATE_KEY: [MessageHandler(filters.TEXT & ~filters.COMMAND, receive_private_key)]
    },
    fallbacks=[CommandHandler("cancel", cancel_command)]
)
```

### 5.2 æŒä»“åˆ—è¡¨åˆ†é¡µä¼ªä»£ç 

```python
async def handle_positions_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    
    # åŠ è½½ç”¨æˆ·é’±åŒ…
    user_wallet = user_wallet_service.get_user_wallet(user_id)
    if not user_wallet:
        await update.message.reply_text("è¯·å…ˆä½¿ç”¨ /start åˆå§‹åŒ–é’±åŒ…")
        return
    
    wallet = user_wallet.to_wallet()
    
    # è·å–æŒä»“æ•°æ®
    positions = position_service.get_positions(wallet)
    
    # åˆ†é¡µ
    page = context.user_data.get('positions_page', 1)
    paginated = PaginationHelper.paginate(positions, page=page, page_size=10)
    
    # æ ¼å¼åŒ–æ¶ˆæ¯
    message = format_positions_message(paginated)
    
    # åˆ›å»ºæŒ‰é’®
    buttons = []
    
    # é€‰æ‹©æŒä»“æŒ‰é’®
    for i in range(len(paginated.items)):
        global_index = (page - 1) * 10 + i
        buttons.append([
            InlineKeyboardButton(
                f"é€‰æ‹© #{global_index + 1}",
                callback_data=f"pos_select_{global_index}"
            )
        ])
    
    # ç¿»é¡µæŒ‰é’®
    pagination_buttons = PaginationHelper.create_pagination_keyboard(
        paginated, 
        callback_prefix="pos_page"
    )
    
    buttons.extend(pagination_buttons.inline_keyboard)
    
    await update.message.reply_text(
        message,
        reply_markup=InlineKeyboardMarkup(buttons),
        parse_mode="Markdown"
    )

async def handle_position_select(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    
    # è§£æç´¢å¼•
    index = int(query.data.split("_")[-1])
    
    # é‡æ–°è·å–æŒä»“æ•°æ®
    user_wallet = user_wallet_service.get_user_wallet(query.from_user.id)
    positions = position_service.get_positions(user_wallet.to_wallet())
    
    if index >= len(positions):
        await query.edit_message_text("æŒä»“ä¸å­˜åœ¨")
        return
    
    position = positions[index]
    
    # æ ¼å¼åŒ–æŒä»“è¯¦æƒ…
    message = format_position_detail(position)
    
    # åˆ›å»ºæ“ä½œæŒ‰é’®
    buttons = create_position_action_buttons(position)
    
    await query.edit_message_text(
        message,
        reply_markup=buttons,
        parse_mode="Markdown"
    )
```

### 5.3 è®¢å•å–æ¶ˆä¼ªä»£ç 

```python
async def handle_orders_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    user_wallet = user_wallet_service.get_user_wallet(user_id)
    
    if not user_wallet:
        await update.message.reply_text("è¯·å…ˆä½¿ç”¨ /start åˆå§‹åŒ–é’±åŒ…")
        return
    
    # è·å–æ´»è·ƒè®¢å•
    orders = order_service.get_orders()
    
    if not orders:
        await update.message.reply_text("å½“å‰æ²¡æœ‰æ´»è·ƒè®¢å•")
        return
    
    # åˆ†é¡µ
    page = context.user_data.get('orders_page', 1)
    paginated = PaginationHelper.paginate(orders, page=page, page_size=10)
    
    # æ ¼å¼åŒ–æ¶ˆæ¯
    message = format_orders_message(paginated)
    
    # åˆ›å»ºæŒ‰é’®ï¼ˆé€‰æ‹© + ç¿»é¡µï¼‰
    buttons = create_order_selection_buttons(paginated, page)
    
    await update.message.reply_text(
        message,
        reply_markup=InlineKeyboardMarkup(buttons),
        parse_mode="Markdown"
    )

async def handle_order_cancel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    
    # è§£æ order_id
    order_id = query.data.split("_")[-1]
    
    try:
        # è°ƒç”¨ OrderService å–æ¶ˆè®¢å•
        result = order_service.cancel_order(order_id)
        
        await query.edit_message_text(
            f"âœ… è®¢å•å·²å–æ¶ˆ\n"
            f"è®¢å•ID: `{order_id}`",
            parse_mode="Markdown"
        )
    except Exception as e:
        await query.edit_message_text(
            f"âŒ å–æ¶ˆè®¢å•å¤±è´¥: {str(e)}"
        )
```

### 5.4 é€šç”¨åˆ†é¡µç»„ä»¶ä¼ªä»£ç 

```python
from typing import TypeVar, Generic, List
from dataclasses import dataclass

T = TypeVar('T')

@dataclass
class PaginatedData(Generic[T]):
    items: List[T]
    page: int
    page_size: int
    total_items: int
    total_pages: int
    has_next: bool
    has_prev: bool

class PaginationHelper:
    @staticmethod
    def paginate(items: List[T], page: int = 1, page_size: int = 10) -> PaginatedData[T]:
        """å¯¹åˆ—è¡¨æ•°æ®è¿›è¡Œåˆ†é¡µ"""
        total_items = len(items)
        total_pages = (total_items + page_size - 1) // page_size  # å‘ä¸Šå–æ•´
        
        # è¾¹ç•Œæ£€æŸ¥
        if page < 1:
            page = 1
        if page > total_pages and total_pages > 0:
            page = total_pages
        
        # è®¡ç®—åˆ‡ç‰‡
        start_index = (page - 1) * page_size
        end_index = start_index + page_size
        page_items = items[start_index:end_index]
        
        return PaginatedData(
            items=page_items,
            page=page,
            page_size=page_size,
            total_items=total_items,
            total_pages=total_pages,
            has_next=page < total_pages,
            has_prev=page > 1
        )
    
    @staticmethod
    def create_pagination_keyboard(
        paginated_data: PaginatedData,
        callback_prefix: str
    ) -> InlineKeyboardMarkup:
        """åˆ›å»ºç¿»é¡µæŒ‰é’®"""
        buttons = []
        
        nav_buttons = []
        if paginated_data.has_prev:
            nav_buttons.append(
                InlineKeyboardButton("â¬…ï¸ ä¸Šä¸€é¡µ", callback_data=f"{callback_prefix}_{paginated_data.page - 1}")
            )
        
        nav_buttons.append(
            InlineKeyboardButton(
                f"{paginated_data.page}/{paginated_data.total_pages}",
                callback_data="noop"
            )
        )
        
        if paginated_data.has_next:
            nav_buttons.append(
                InlineKeyboardButton("â¡ï¸ ä¸‹ä¸€é¡µ", callback_data=f"{callback_prefix}_{paginated_data.page + 1}")
            )
        
        buttons.append(nav_buttons)
        return InlineKeyboardMarkup(buttons)